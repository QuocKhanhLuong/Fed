# =====================================================================
# Nested Early-Exit Federated Learning with Flower 1.18+
# =====================================================================

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "nestedfl"
version = "1.0.0"
description = "Nested Early-Exit Federated Learning for Edge Devices"
license = "Apache-2.0"
authors = [
    { name = "Research Team" }
]
dependencies = [
    "flwr[simulation]>=1.18.0",
    "torch>=2.0.0",
    "torchvision>=0.15.0",
    "timm>=0.9.0",
    "numpy>=1.21.0",
]

[tool.hatch.build.targets.wheel]
packages = ["."]

[tool.flwr.app]
publisher = "research"

# Point to your ServerApp and ClientApp objects
[tool.flwr.app.components]
serverapp = "nestedfl.server_app:app"
clientapp = "nestedfl.client_app:app"

# =====================================================================
# Run Configuration
# =====================================================================
[tool.flwr.app.config]
# FL Settings
num-server-rounds = 10
fraction-train = 1.0
fraction-evaluate = 0.5

# Training
local-epochs = 3
lr = 0.001
batch-size = 32

# Dataset
dataset = "cifar100"  # or "cifar10"
num-classes = 100

# Nested Learning Parameters
fast-lr-mult = 3.0
slow-update-freq = 5
use-distillation = true
cms-enabled = true
use-lss = true

# =====================================================================
# Federations
# =====================================================================
[tool.flwr.federations]
default = "local-simulation"

# Local simulation with 3 clients (RTX 4070 optimized)
[tool.flwr.federations.local-simulation]
options.num-supernodes = 3

# GPU resource allocation (0.33 GPU per client = 3 clients on 1 GPU)
[tool.flwr.federations.local-simulation.options.backend.client-resources]
num-cpus = 1
num-gpus = 0.33

# Remote federation for distributed training
[tool.flwr.federations.remote-federation]
address = "<SUPERLINK-ADDRESS>:9091"
insecure = true
